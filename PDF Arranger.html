<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PDF Page Arranger with Drag & Drop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: Arial; text-align: center; padding: 20px; }
        canvas { border: 1px solid #ccc; margin: 10px; }
        .page-item { 
            display: inline-block; 
            position: relative; 
            margin: 10px; 
            cursor: grab;
        }
        .delete-checkbox { 
            position: absolute; 
            top: 5px; 
            left: 5px; 
            transform: scale(1.5); 
        }
        #pagesContainer { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
    </style>
</head>
<body>
    <h2>PDF Page Arranger (Drag & Drop)</h2>
    <input type="file" id="fileInput" accept="application/pdf" />
    <div id="pagesContainer"></div>
    <button onclick="processPDF()">Generate New PDF</button>

    <script>
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let pdfDoc = null;

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const fileReader = new FileReader();

            fileReader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                pdfDoc = await pdfjsLib.getDocument({ data: typedarray }).promise;
                renderPages();
            };

            fileReader.readAsArrayBuffer(file);
        });

        async function renderPages() {
            const container = document.getElementById('pagesContainer');
            container.innerHTML = '';

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.5 });

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const context = canvas.getContext('2d');

                const renderContext = { canvasContext: context, viewport: viewport };
                await page.render(renderContext).promise;

                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                pageItem.draggable = true;
                pageItem.dataset.pageNumber = i;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'delete-checkbox';
                checkbox.dataset.pageNumber = i;

                pageItem.appendChild(checkbox);
                pageItem.appendChild(canvas);
                container.appendChild(pageItem);

                // Add Drag & Drop Events
                pageItem.addEventListener('dragstart', handleDragStart);
                pageItem.addEventListener('dragover', handleDragOver);
                pageItem.addEventListener('drop', handleDrop);
            }
        }

        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            if (draggedItem !== this) {
                const container = this.parentNode;
                const draggedIndex = Array.from(container.children).indexOf(draggedItem);
                const targetIndex = Array.from(container.children).indexOf(this);

                if (draggedIndex < targetIndex) {
                    container.insertBefore(draggedItem, this.nextSibling);
                } else {
                    container.insertBefore(draggedItem, this);
                }
            }
        }

        async function processPDF() {
            if (!pdfDoc) return;

            const pageItems = document.querySelectorAll('.page-item');
            const pagesToRemove = [];
            const newPageOrder = [];

            pageItems.forEach(item => {
                const cb = item.querySelector('.delete-checkbox');
                const pageNum = parseInt(cb.dataset.pageNumber);
                if (cb.checked) {
                    pagesToRemove.push(pageNum);
                } else {
                    newPageOrder.push(pageNum);
                }
            });

            const pdfBytes = await pdfDoc.getData();
            const originalPdf = await PDFLib.PDFDocument.load(pdfBytes);
            const newPdf = await PDFLib.PDFDocument.create();

            for (const pageNum of newPageOrder) {
                const [copiedPage] = await newPdf.copyPages(originalPdf, [pageNum - 1]);
                newPdf.addPage(copiedPage);
            }

            const newPdfBytes = await newPdf.save();
            const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Processed.pdf';
            link.click();
        }
    </script>
</body>
</html>
